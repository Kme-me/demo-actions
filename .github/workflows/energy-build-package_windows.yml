name: Energy Build and Package Windows

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*.*.*'

jobs:
  windows-64:
    runs-on: ${{ matrix.operating-system }}

    strategy:
      matrix:
        operating-system: [ windows-2019 ]

    env:
      ENERGY_HOME: "D:/app/energy/EnergyFramework"
      NSIS_HOME: "D:/app/energy/nsis"
      Z7Z_HOME: "D:/app/energy/7za"

    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v3
        with:
          go-version: '1.20'

      - name: Config Base Environment
        run: |
          mkdir D:/app
          mkdir D:/app/install
        shell: bash

      - name: Clone ENERGY
        run: |
          cd D:/app
          git clone https://github.com/energye/energy.git
          cd energy/cmd/energy
          go install
        shell: bash

      - name: Install ENERGY ENV
        run: |
          cd D:/app
          energy cli -v
          energy install --all --cef=109
        shell: bash

      - name: Build and Package
        run: |
          energy env
          cd $RUNNER_WORKSPACE/demo-actions
          energy build
          energy package
          mv $RUNNER_WORKSPACE/demo-actions/build/windows/demo-actions-installer.exe D:/app/install/
          ls -al D:/app/install/
        shell: bash

      - name: Release Dynamic library
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: D:/app/install/**
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

